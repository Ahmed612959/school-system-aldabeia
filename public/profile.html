<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ - SchoolX Ø¨ÙˆØ±Ø³Ø¹ÙŠØ¯</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <style>
        :root{--g:#d4af37;--d:#1a2526;--d2:#2a3a3b}
        *{margin:0;padding:0;box-sizing:border-box}
        body{
            font-family:'Cairo',sans-serif;
            background:#0f1419;
            color:#fff;
            min-height:100vh;
            padding-bottom:72px;
            font-size:12.8px;
            line-height:1.4;
        }
        .c{padding:7px}
        header{text-align:center;padding:10px 0}
        .logo{width:42px;height:42px;border:2.5px solid var(--g);border-radius:50%;padding:3px;background:#fff}
        h1{color:var(--g);font-size:1.12rem;margin-top:5px}

        .card{
            background:#fff;color:#111;border-radius:14px;overflow:hidden;
            box-shadow:0 5px 18px rgba(0,0,0,0.5);margin:7px 0;
        }
        .ch{
            background:linear-gradient(135deg,var(--g),#b8972e);
            padding:11px 8px;text-align:center;color:#fff;
        }
        .ch h2{font-size:1.08rem;margin:3px 0}
        #admin-badge{font-size:1.3rem}

        .p{padding:10px;text-align:center;background:#fafafa}
        .p label{font-size:0.74rem;font-weight:bold;color:#333;margin-bottom:4px}
        progress{width:100%;height:6px;border-radius:3px}
        progress::-webkit-progress-value{background:var(--g);border-radius:3px}
        #pp{margin-top:4px;font-size:0.98rem;color:var(--g);font-weight:bold}

        .f{padding:11px 9px}
        .ig{margin-bottom:9px}
        .ig label{font-size:0.73rem;color:#333;margin-bottom:3px;font-weight:600}
        .ig input,.ig textarea{
            width:100%;padding:7px 9px;border:1.8px solid var(--g);
            border-radius:8px;font-size:0.81rem;background:#fdfdfd;
        }
        .ig input:focus,.ig textarea:focus{outline:none;border-color:var(--d);background:#fff}
        .ig input[disabled]{background:#f0f0f0;color:#777}

        .btn{
            width:100%;padding:9px;background:var(--g);color:var(--d);
            border:none;border-radius:9px;font-size:0.88rem;font-weight:bold;
            cursor:pointer;margin-top:5px;
        }
        .btn:hover{background:#b8972e}

        .nav{
            position:fixed;bottom:0;left:0;right:0;
            background:linear-gradient(180deg,var(--d),var(--d2));
            padding:12px 20px 22px;display:flex;justify-content:space-around;
            align-items:center;border-top-left-radius:24px;border-top-right-radius:24px;
            border-top:3px solid var(--g);box-shadow:0 -8px 30px rgba(0,0,0,0.8);z-index:9999;
        }
        .nav::before{
            content:'';position:absolute;top:-30px;left:50%;transform:translateX(-50%);
            width:100px;height:50px;background:var(--g);border-radius:50%;opacity:0.2;filter:blur(20px);
        }
        .nav a{
            color:var(--g);font-size:1.45rem;padding:10px 14px;
            background:rgba(255,255,255,0.05);border-radius:50%;
            transition:all .4s ease;position:relative;backdrop-filter:blur(10px);
        }
        .nav a.active{
            color:#fff;background:var(--g);transform:translateY(-12px) scale(1.15);
            box-shadow:0 8px 25px rgba(212,175,55,0.6);
        }
        .nav a.active::after{
            content:'';position:absolute;bottom:-12px;left:50%;transform:translateX(-50%);
            width:7px;height:7px;background:var(--g);border-radius:50%;box-shadow:0 0 20px var(--g);
        }
    </style>
</head>
<body>

<div class="c">
    <header>
        <img src="logo.png" alt="Logo" class="logo">
        <h1>Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</h1>
    </header>

    <div class="card">
        <div class="ch">
            <h2 id="user-name">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</h2>
            <span id="admin-badge" style="display:none;">ğŸ‘‘</span>
        </div>

        <div class="p">
            <label>Ù†Ø³Ø¨Ø© Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ù…Ù„Ù</label>
            <progress id="profile-progress" value="0" max="100"></progress>
            <div id="progress-percentage">0%</div>
        </div>

        <div class="f">
            <form id="profile-form">
                <div class="ig"><label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label><input type="text" id="full-name" disabled></div>
                <div class="ig"><label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label><input type="text" id="username" disabled></div>
                <div class="ig"><label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label><input type="tel" id="phone"></div>
                <div class="ig"><label>Ø§Ø³Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</label><input type="text" id="parentName"></div>
                <div class="ig"><label>Ø±Ù‚Ù… Ø¨Ø·Ø§Ù‚Ø© ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</label><input type="text" id="parentId"></div>
                <button type="submit" class="btn">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
            </form>
        </div>
    </div>
</div>

<nav class="nav"></nav>

<script>
document.addEventListener('DOMContentLoaded', async () => {
    const loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));

    if (!loggedInUser || !loggedInUser.username || !loggedInUser.type) {
        Toastify({ text: "ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹!", backgroundColor: "#dc3545", duration: 4000 }).showToast();
        setTimeout(() => window.location.href = 'login.html', 2000);
        return;
    }

    const username = loggedInUser.username;
    const userType = loggedInUser.type;

    let user = null;
    try {
        // Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ: Ø§Ø³ØªØ®Ø¯Ø§Ù… backticks ØµØ­
        const response = await fetch(`/api/\( {userType}s/ \){username}`);

        if (!response.ok) {
            if (response.status === 404) {
                Toastify({ text: "Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!", backgroundColor: "#dc3545", duration: 6000 }).showToast();
            } else {
                Toastify({ text: `Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±: ${response.status}`, backgroundColor: "#dc3545", duration: 6000 }).showToast();
            }
            return;
        }

        user = await response.json();

    } catch (err) {
        Toastify({ text: "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª Ø£Ùˆ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±", backgroundColor: "#dc3545", duration: 7000 }).showToast();
        return;
    }

    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ profile
    user.profile = user.profile || { phone: '', parentName: '', parentId: '' };

    // Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    document.getElementById('user-name').textContent = user.fullName || user.username;
    document.getElementById('full-name').value = user.fullName || '';
    document.getElementById('username').value = user.username;
    document.getElementById('phone').value = user.profile.phone || '';
    document.getElementById('parentName').value = user.profile.parentName || '';
    document.getElementById('parentId').value = user.profile.parentId || '';

    // Ø­Ø³Ø§Ø¨ Ù†Ø³Ø¨Ø© Ø§Ù„Ø§ÙƒØªÙ…Ø§Ù„ (3 Ø­Ù‚ÙˆÙ„)
    const fields = ['phone', 'parentName', 'parentId'];
    const completed = fields.filter(f => user.profile[f]?.trim()).length;
    const percentage = Math.round((completed / 3) * 100);
    document.getElementById('profile-progress').value = percentage;
    document.getElementById('progress-percentage').textContent = percentage + '%';

    if (userType === 'admin') {
        document.getElementById('admin-badge').style.display = 'inline-block';
    }

    Toastify({
        text: `Ø£Ù‡Ù„Ø§Ù‹ ÙŠØ§ ${user.fullName?.split(' ')[0] || username}!`,
        backgroundColor: "#d4af37",
        duration: 4000
    }).showToast();

    // Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
    document.getElementById('profile-form').addEventListener('submit', async (e) => {
        e.preventDefault();

        const updatedProfile = {
            phone: document.getElementById('phone').value.trim(),
            parentName: document.getElementById('parentName').value.trim(),
            parentId: document.getElementById('parentId').value.trim()
        };

        try {
            // Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªØ§Ù†ÙŠ Ù‡Ù†Ø§ ÙƒÙ…Ø§Ù†
            const res = await fetch(`/api/\( {userType}s/ \){username}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ profile: updatedProfile })
            });

            if (res.ok) {
                const newPercentage = Math.round((fields.filter(f => updatedProfile[f]).length / 3) * 100);
                document.getElementById('profile-progress').value = newPercentage;
                document.getElementById('progress-percentage').textContent = newPercentage + '%';

                Toastify({
                    text: newPercentage === 100 ? "Ù…Ø¨Ø±ÙˆÙƒ! Ù…Ù„ÙÙƒ Ù…ÙƒØªÙ…Ù„ 100%" : "ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­!",
                    backgroundColor: "#28a745",
                    duration: 4000
                }).showToast();
            } else {
                Toastify({ text: "ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø­ÙØ¸", backgroundColor: "#dc3545" }).showToast();
            }
        } catch (err) {
            Toastify({ text: "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª", backgroundColor: "#dc3545" }).showToast();
        }
    });

    // Ø§Ù„Ù†Ø§Ù Ø¨Ø§Ø±
    const navItems = [
        { href: 'index.html', icon: 'fa-solid fa-house' },
        { href: 'Home.html', icon: 'fa-solid fa-chart-line' },
        { href: 'profile.html', icon: 'fa-solid fa-user', active: true },
        { href: 'exams.html', icon: 'fa-solid fa-book-open' },
        { href: 'leaderboard.html', icon: 'fa-solid fa-trophy' }
    ];

    if (userType === 'admin') {
        navItems.push({ href: 'admin.html', icon: 'fa-solid fa-cogs' });
    }

    document.querySelector('.nav').innerHTML = navItems.map(item => 
        `<a href="\( {item.href}" class=" \){item.active ? 'active' : ''}"><i class="${item.icon}"></i></a>`
    ).join('');
});
</script>

</body>
</html>